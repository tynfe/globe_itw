name: DBT CI/CD Pipeline

on:
  push:

  workflow_dispatch:

env:
  DBT_PROFILES_DIR: ./
  DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
  DBT_SNOWFLAKE_PW: ${{ secrets.DBT_SNOWFLAKE_PW }}
  DBT_USER_GLOBE: ${{ secrets.DBT_USER_GLOBE }}
  DBT_ACCOUNT_GLOBE: ${{ secrets.DBT_ACCOUNT_GLOBE }}
  DBT_PASSWORD_GLOBE: ${{ secrets.DBT_PASSWORD_GLOBE }}

jobs:
  # ============================================
  # DEV BUILD - Sur tous les push
  # ============================================
  dbt_build_dev:
    name: Dev Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake sqlfluff 
          dbt deps

      - name: Set dev schema
        run: |
          # Sch√©ma: dev_username_branchname
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr '/' '_')
          echo "DBT_SCHEMA=dev_${GITHUB_ACTOR}_${BRANCH_NAME}" >> $GITHUB_ENV
          echo "Using schema: dev_${GITHUB_ACTOR}_${BRANCH_NAME}"

      - name: Download staging artifact from main branch
        uses: dawidd6/action-download-artifact@v2
        with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            workflow: deploy.yml
            branch: staging
            name:  staging-artifacts
            path: staging-state/
            check_artifacts: true
            search_artifacts: true
            if_no_artifact_found: fail

      - name: Build with defer
        run: |
          dbt build \
            --target dev \
            --select state:modified+ \
            --defer \
            --state ./staging-state

      - name: Run all tests with defer
        run: |
          dbt test \
            --target dev \
            --defer \
            --state ./staging-state \
            --select state:modified+  # Teste seulement les mod√®les modifi√©s

      - name: Run linting
        run: sqlfluff lint --dialect snowflake models/
        continue-on-error: true  # Fail si linting √©choue mais ici j'utilise false pour la demo

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-artifacts-${{ github.run_id }}
          path: target/
          retention-days: 3

  # ============================================
  # STAGING BUILD - Seulement si dev r√©ussit
  # ============================================
  dbt_build_staging:
    name: Staging Build
    runs-on: ubuntu-latest
    needs: dbt_build_dev  # D√©pend du succ√®s de dev
    if: success() && github.ref != 'refs/heads/main' && github.ref != 'refs/heads/staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake
          dbt deps

      - name: Build staging
        env:
          DBT_DATABASE: DHW_DEV_TYRON
          DBT_SCHEMA: ETL
        run: dbt build --target staging

  # ============================================
  # STAGING BUILD - Direct sur main
  # ============================================
  dbt_staging_main:
    name: Staging Build (Main)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake
          dbt deps

      - name: Build staging
        env:
          DBT_DATABASE: DHW_DEV_TYRON
          DBT_SCHEMA: ETL
        run: |
          dbt build --target staging
          dbt docs generate --target staging

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-artifacts
          path: target/
          retention-days: 7

  # ============================================
  # PRODUCTION - Tags uniquement
  # ============================================
  dbt_build_prod:
    name: Production Deployment
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake
          dbt deps

      - name: Deploy to production
        env:
          DBT_DATABASE: DHW_PROD_TYRON
          DBT_SCHEMA: PROD
        run: |
          echo "üöÄ Deploying to PRODUCTION - Tag: ${{ github.ref_name }}"
          dbt build --target prod --full-refresh
          dbt docs generate --target prod