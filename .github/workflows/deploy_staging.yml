name: DBT Staging Pipeline

on:
  push:
    branches:
      - '**'
      - '!main'
  pull_request:
    branches:
      - staging

permissions:
  actions: read
  contents: read

env:
  DBT_PROFILES_DIR: ./
  DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
  DBT_SNOWFLAKE_PW: ${{ secrets.DBT_SNOWFLAKE_PW }}
  DBT_USER_GLOBE: ${{ secrets.DBT_USER_GLOBE }}
  DBT_ACCOUNT_GLOBE: ${{ secrets.DBT_ACCOUNT_GLOBE }}
  DBT_PASSWORD_GLOBE: ${{ secrets.DBT_PASSWORD_GLOBE }}

jobs:
  dbt_build_dev:
    name: Dev Build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref != 'refs/heads/staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake sqlfluff
          dbt deps

      - name: Set dev schema
        run: |
          BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr '/' '_')
          echo "DBT_SCHEMA=dev_${GITHUB_ACTOR}_${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Download staging state
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: staging.yml
          branch: staging
          name: staging-artifacts
          path: staging-state/
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Build with defer
        if: hashFiles('staging-state/**')
        run: |
          dbt build --target dev --select state:modified+ --defer --state ./staging-state

      - name: Build without defer
        if: "!hashFiles('staging-state/**')"
        run: dbt build --target dev

      - name: Run tests
        run: dbt test --target dev

      - name: Run linting
        run: sqlfluff lint --dialect snowflake models/
        continue-on-error: true

      - name: Upload dev artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-artifacts-${{ github.run_id }}
          path: target/
          retention-days: 3

  dbt_build_staging:
    name: Staging Build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/staging'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake elementary-data
          dbt deps

      - name: Build staging + docs
        env:
          DBT_DATABASE: DHW_DEV_TYRON
          DBT_SCHEMA: ETL
        run: |
          dbt build --target staging
          dbt docs generate --target staging

      - name: Generate Elementary Report
        run: |
          edr report --target-path ./elementary-data --profiles-dir ./
        continue-on-error: true

      - name: Upload staging artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-artifacts
          path: target/
          retention-days: 7

      - name: Upload staging docs
        uses: actions/upload-artifact@v4
        with:
          name: staging-docs
          path: target/
          retention-days: 30

      - name: Upload Elementary staging report
        uses: actions/upload-artifact@v4
        with:
          name: elementary-staging-report
          path: ./elementary-data/elementary_report.html
          retention-days: 30
        if: success()