name: DBT Production Pipeline

on:
  push:
    tags:
      - 'v*'

permissions:
  actions: read
  contents: read

env:
  DBT_PROFILES_DIR: ./
  DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
  DBT_SNOWFLAKE_PW: ${{ secrets.DBT_SNOWFLAKE_PW }}
  DBT_USER_GLOBE: ${{ secrets.DBT_USER_GLOBE }}
  DBT_ACCOUNT_GLOBE: ${{ secrets.DBT_ACCOUNT_GLOBE }}
  DBT_PASSWORD_GLOBE: ${{ secrets.DBT_PASSWORD_GLOBE }}

jobs:
  dbt_build_prod:
    name: Production Deployment
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-snowflake elementary-data
          dbt deps

      - name: Download staging state
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: deploy_staging.yml
          branch: staging
          name: staging-artifacts
          path: staging-state/
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Deploy to production + docs
        env:
          DBT_DATABASE: DHW_PROD_TYRON
          DBT_SCHEMA: GOLD
        run: |
          echo "ðŸš€ Deploying to PRODUCTION - Tag: ${{ github.ref_name }}"
          dbt build --target prod
          dbt docs generate --target prod

      - name: Generate Elementary Report
        run: |
          edr report --target-path ./elementary-data --profiles-dir ./
        continue-on-error: true

      - name: Upload production docs
        uses: actions/upload-artifact@v4
        with:
          name: prod-docs
          path: target/
          retention-days: 90

      - name: Upload Elementary prod report
        uses: actions/upload-artifact@v4
        with:
          name: elementary-prod-report
          path: ./elementary-data/elementary_report.html
          retention-days: 90
        if: success()